<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GeoIntel — Relocation Decision Engine</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=IBM+Plex+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500&display=swap" rel="stylesheet" />

  <style>
    /* ── Variables ───────────────────────────────────────────────── */
    :root {
      --bg:        #07080d;
      --bg2:       #0d0f18;
      --bg3:       #131623;
      --border:    #1e2235;
      --border2:   #2a2f4a;
      --gold:      #c9a84c;
      --gold2:     #e8c96a;
      --gold-dim:  #c9a84c22;
      --red:       #e05252;
      --green:     #4caf7d;
      --blue:      #4a7fc1;
      --text:      #d4d8e8;
      --text2:     #7880a0;
      --text3:     #4a5070;
      --mono:      'IBM Plex Mono', monospace;
      --serif:     'Playfair Display', serif;
      --sans:      'IBM Plex Sans', sans-serif;
    }

    /* ── Reset ───────────────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    html { scroll-behavior: smooth; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
    }

    /* ── Grid texture overlay ─────────────────────────────────────── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image:
        linear-gradient(var(--border) 1px, transparent 1px),
        linear-gradient(90deg, var(--border) 1px, transparent 1px);
      background-size: 48px 48px;
      opacity: 0.25;
      pointer-events: none;
      z-index: 0;
    }

    /* ── Noise overlay ────────────────────────────────────────────── */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
      opacity: 0.6;
      pointer-events: none;
      z-index: 0;
    }

    /* ── Layout ───────────────────────────────────────────────────── */
    .app {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 24px 80px;
    }

    /* ── Header ───────────────────────────────────────────────────── */
    header {
      padding: 40px 0 32px;
      border-bottom: 1px solid var(--border);
      margin-bottom: 40px;
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 16px;
    }

    .logo-block { display: flex; flex-direction: column; gap: 4px; }

    .logo-eyebrow {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.2em;
      color: var(--gold);
      text-transform: uppercase;
    }

    .logo-title {
      font-family: var(--serif);
      font-size: clamp(28px, 5vw, 46px);
      font-weight: 900;
      color: #fff;
      letter-spacing: -0.01em;
      line-height: 1;
    }

    .logo-title span { color: var(--gold); }

    .header-meta {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
      text-align: right;
      line-height: 1.8;
    }

    /* ── Section labels ───────────────────────────────────────────── */
    .section-label {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.25em;
      text-transform: uppercase;
      color: var(--gold);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .section-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    /* ── Form panel ───────────────────────────────────────────────── */
    .form-panel {
      background: var(--bg2);
      border: 1px solid var(--border);
      padding: 32px;
      margin-bottom: 40px;
      position: relative;
      overflow: hidden;
    }

    .form-panel::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gold), transparent);
    }

    /* ── Country tags ─────────────────────────────────────────────── */
    .country-input-area {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 24px;
    }

    .tags-container {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 42px;
      padding: 8px;
      background: var(--bg3);
      border: 1px solid var(--border);
      cursor: text;
      transition: border-color 0.2s;
    }

    .tags-container:focus-within { border-color: var(--gold); }

    .country-tag {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--gold-dim);
      border: 1px solid var(--gold);
      color: var(--gold2);
      font-family: var(--mono);
      font-size: 11px;
      padding: 4px 10px;
      animation: tagIn 0.2s ease;
    }

    @keyframes tagIn {
      from { opacity: 0; transform: scale(0.9); }
      to   { opacity: 1; transform: scale(1); }
    }

    .tag-remove {
      cursor: pointer;
      color: var(--text3);
      font-size: 14px;
      line-height: 1;
      background: none;
      border: none;
      color: var(--gold);
      opacity: 0.5;
      transition: opacity 0.15s;
    }
    .tag-remove:hover { opacity: 1; }

    .tag-input {
      flex: 1;
      min-width: 150px;
      background: none;
      border: none;
      outline: none;
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      padding: 4px 4px;
    }
    .tag-input::placeholder { color: var(--text3); }

    .input-hint {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
    }

    /* ── Form row ─────────────────────────────────────────────────── */
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 24px;
    }

    .field-group { display: flex; flex-direction: column; gap: 8px; }

    .field-label {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--text2);
    }

    .toggle-group {
      display: flex;
      gap: 0;
    }

    .toggle-btn {
      flex: 1;
      padding: 10px 16px;
      background: var(--bg3);
      border: 1px solid var(--border);
      color: var(--text2);
      font-family: var(--mono);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      letter-spacing: 0.05em;
      margin-left: -1px;
    }
    .toggle-btn:first-child { margin-left: 0; }
    .toggle-btn:hover { color: var(--text); border-color: var(--border2); z-index: 1; }
    .toggle-btn.active {
      background: var(--gold-dim);
      border-color: var(--gold);
      color: var(--gold2);
      z-index: 2;
    }

    /* ── Analyze button ───────────────────────────────────────────── */
    .analyze-btn {
      width: 100%;
      padding: 16px;
      background: var(--gold);
      border: none;
      color: var(--bg);
      font-family: var(--mono);
      font-size: 12px;
      font-weight: 500;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      overflow: hidden;
    }

    .analyze-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: #fff2;
      transform: translateX(-100%);
      transition: transform 0.3s ease;
    }
    .analyze-btn:hover::after { transform: translateX(0); }
    .analyze-btn:hover { background: var(--gold2); }
    .analyze-btn:disabled {
      background: var(--border2);
      color: var(--text3);
      cursor: not-allowed;
    }
    .analyze-btn:disabled::after { display: none; }

    /* ── Error message ────────────────────────────────────────────── */
    .error-msg {
      background: #e0525215;
      border: 1px solid #e05252;
      color: #e05252;
      font-family: var(--mono);
      font-size: 11px;
      padding: 12px 16px;
      margin-top: 16px;
      display: none;
    }
    .error-msg.visible { display: block; animation: fadeIn 0.3s ease; }

    /* ── Loading ─────────────────────────────────────────────────── */
    .loading-panel {
      display: none;
      text-align: center;
      padding: 60px 0;
      animation: fadeIn 0.3s ease;
    }
    .loading-panel.visible { display: block; }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 2px solid var(--border2);
      border-top-color: var(--gold);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 24px;
    }

    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

    .loading-text {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text2);
      letter-spacing: 0.15em;
    }

    .loading-steps {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 20px;
      align-items: center;
    }

    .loading-step {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
      opacity: 0;
      animation: stepIn 0.4s ease forwards;
    }
    .loading-step:nth-child(1) { animation-delay: 0.3s; }
    .loading-step:nth-child(2) { animation-delay: 0.9s; }
    .loading-step:nth-child(3) { animation-delay: 1.5s; }
    .loading-step:nth-child(4) { animation-delay: 2.1s; }
    @keyframes stepIn { to { opacity: 0.7; } }

    /* ── Results ─────────────────────────────────────────────────── */
    #results { display: none; animation: fadeIn 0.5s ease; }
    #results.visible { display: block; }

    /* ── Meta bar ─────────────────────────────────────────────────── */
    .meta-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      padding: 16px 24px;
      background: var(--bg2);
      border: 1px solid var(--border);
      margin-bottom: 32px;
      font-family: var(--mono);
      font-size: 10px;
    }

    .meta-item { display: flex; flex-direction: column; gap: 3px; }
    .meta-key { color: var(--text3); letter-spacing: 0.1em; }
    .meta-val { color: var(--text); }
    .meta-val.good { color: var(--green); }
    .meta-val.warn { color: var(--gold); }

    /* ── Country cards ────────────────────────────────────────────── */
    .results-grid {
      display: grid;
      gap: 20px;
    }

    .country-card {
      background: var(--bg2);
      border: 1px solid var(--border);
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.5s ease both;
    }
    .country-card:nth-child(1) { animation-delay: 0.1s; }
    .country-card:nth-child(2) { animation-delay: 0.2s; }
    .country-card:nth-child(3) { animation-delay: 0.3s; }
    .country-card:nth-child(n+4) { animation-delay: 0.4s; }

    .country-card.rank-1 { border-color: var(--gold); }
    .country-card.rank-1::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 2px;
      background: linear-gradient(90deg, var(--gold), var(--gold2), var(--gold));
    }

    /* Card header */
    .card-header {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 20px 24px 16px;
      border-bottom: 1px solid var(--border);
    }

    .rank-badge {
      font-family: var(--serif);
      font-size: 28px;
      font-weight: 700;
      color: var(--text3);
      min-width: 36px;
      line-height: 1;
    }
    .country-card.rank-1 .rank-badge { color: var(--gold); }
    .country-card.rank-2 .rank-badge { color: var(--text2); }

    .flag-img {
      width: 36px;
      height: 24px;
      object-fit: cover;
      border: 1px solid var(--border);
      flex-shrink: 0;
    }

    .card-title-block { flex: 1; }

    .card-country-name {
      font-family: var(--serif);
      font-size: 20px;
      font-weight: 700;
      color: #fff;
      line-height: 1.1;
    }

    .card-subtitle {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text2);
      margin-top: 3px;
    }

    .composite-score {
      text-align: right;
    }

    .score-big {
      font-family: var(--serif);
      font-size: 36px;
      font-weight: 900;
      line-height: 1;
    }

    .score-label {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 0.1em;
      text-align: right;
      margin-top: 2px;
    }

    .rank-label-tag {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.1em;
      padding: 3px 8px;
      border: 1px solid;
      text-align: right;
      display: inline-block;
      margin-top: 6px;
    }
    .country-card.rank-1 .rank-label-tag { color: var(--gold); border-color: var(--gold); }
    .country-card.rank-2 .rank-label-tag { color: var(--text2); border-color: var(--border2); }
    .country-card.rank-3 .rank-label-tag { color: var(--blue); border-color: var(--blue); }
    .country-card:not(.rank-1):not(.rank-2):not(.rank-3) .rank-label-tag { color: var(--text3); border-color: var(--border); }

    /* Card body */
    .card-body {
      padding: 20px 24px;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    @media (max-width: 700px) {
      .card-body { grid-template-columns: 1fr; }
      .form-row { grid-template-columns: 1fr; }
    }

    /* Score breakdown */
    .score-section h4 {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 12px;
    }

    .score-bars { display: flex; flex-direction: column; gap: 10px; }

    .score-bar-row {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .score-bar-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .score-bar-name {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text2);
    }

    .score-bar-val {
      font-family: var(--mono);
      font-size: 11px;
      font-weight: 500;
    }

    .score-bar-track {
      height: 4px;
      background: var(--bg3);
      border: 1px solid var(--border);
      overflow: hidden;
    }

    .score-bar-fill {
      height: 100%;
      width: 0;
      transition: width 1s cubic-bezier(0.16, 1, 0.3, 1);
    }

    /* Score color helpers */
    .score-high  { color: var(--green); }
    .score-mid   { color: var(--gold); }
    .score-low   { color: var(--red); }
    .fill-high   { background: var(--green); }
    .fill-mid    { background: var(--gold); }
    .fill-low    { background: var(--red); }

    /* Profile data */
    .profile-section h4 {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 12px;
    }

    .profile-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px 16px;
    }

    .profile-item { display: flex; flex-direction: column; gap: 2px; }
    .profile-key {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 0.1em;
      text-transform: uppercase;
    }
    .profile-val {
      font-family: var(--mono);
      font-size: 11px;
      color: var(--text);
    }

    /* Raw data section */
    .card-data {
      padding: 0 24px 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
    }

    .data-chip {
      background: var(--bg3);
      border: 1px solid var(--border);
      padding: 10px 12px;
    }

    .data-chip-key {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text3);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .data-chip-val {
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      font-weight: 500;
    }

    /* Reasoning section */
    .card-reasoning {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: #ffffff04;
    }

    .reasoning-title {
      font-family: var(--mono);
      font-size: 9px;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: var(--text3);
      margin-bottom: 10px;
    }

    .reasoning-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .reasoning-item {
      display: flex;
      gap: 10px;
      font-family: var(--sans);
      font-size: 12px;
      color: var(--text2);
      line-height: 1.5;
    }

    .reasoning-item::before {
      content: '›';
      color: var(--gold);
      font-size: 14px;
      flex-shrink: 0;
      line-height: 1.4;
    }

    /* Cache indicator */
    .cache-dot {
      display: inline-block;
      width: 6px;
      height: 6px;
      border-radius: 50%;
      margin-right: 5px;
      vertical-align: middle;
    }
    .cache-dot.hit  { background: var(--green); }
    .cache-dot.miss { background: var(--text3); }

    /* Data availability warnings */
    .missing-badge {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text3);
      background: var(--bg3);
      border: 1px dashed var(--border);
      padding: 2px 6px;
      letter-spacing: 0.05em;
    }

    /* ── Footer ───────────────────────────────────────────────────── */
    footer {
      margin-top: 60px;
      padding-top: 24px;
      border-top: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .footer-text {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text3);
    }

    .api-badges {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .api-badge {
      font-family: var(--mono);
      font-size: 9px;
      color: var(--text3);
      border: 1px solid var(--border);
      padding: 3px 8px;
      letter-spacing: 0.05em;
    }
  </style>
</head>
<body>

<div class="app">
  <!-- ── Header ── -->
  <header>
    <div class="logo-block">
      <span class="logo-eyebrow">Intelligence Engine v2.0</span>
      <h1 class="logo-title">Geo<span>Intel</span></h1>
    </div>
    <div class="header-meta">
      Global Relocation & Travel<br>Decision Intelligence Engine<br>
      <span id="live-time"></span>
    </div>
  </header>

  <!-- ── Query Panel ── -->
  <div class="form-panel">
    <div class="section-label">Configure Analysis</div>

    <!-- Country tag input -->
    <div class="country-input-area">
      <div class="field-label">Target Countries (min. 3)</div>
      <div class="tags-container" id="tags-container" onclick="document.getElementById('country-input').focus()">
        <input
          type="text"
          id="country-input"
          class="tag-input"
          placeholder="Type a country name and press Enter..."
          autocomplete="off"
        />
      </div>
      <span class="input-hint">Press Enter or comma to add · Click × to remove</span>
    </div>

    <!-- Risk + Duration -->
    <div class="form-row">
      <div class="field-group">
        <label class="field-label">Risk Tolerance</label>
        <div class="toggle-group" id="risk-group">
          <button class="toggle-btn active" data-val="low">Low</button>
          <button class="toggle-btn" data-val="moderate">Moderate</button>
          <button class="toggle-btn" data-val="high">High</button>
        </div>
      </div>
      <div class="field-group">
        <label class="field-label">Duration of Stay</label>
        <div class="toggle-group" id="duration-group">
          <button class="toggle-btn active" data-val="short">Short-term</button>
          <button class="toggle-btn" data-val="long">Long-term</button>
        </div>
      </div>
    </div>

    <button class="analyze-btn" id="analyze-btn" onclick="runAnalysis()">
      ▸ Run Intelligence Analysis
    </button>

    <div class="error-msg" id="error-msg"></div>
  </div>

  <!-- ── Loading ── -->
  <div class="loading-panel" id="loading-panel">
    <div class="loading-spinner"></div>
    <div class="loading-text">PROCESSING INTELLIGENCE REQUEST</div>
    <div class="loading-steps">
      <div class="loading-step">▸ Fetching country profiles from REST Countries...</div>
      <div class="loading-step">▸ Querying World Bank health indicators...</div>
      <div class="loading-step">▸ Retrieving live weather & AQI data...</div>
      <div class="loading-step">▸ Computing intelligence scores and ranking...</div>
    </div>
  </div>

  <!-- ── Results ── -->
  <div id="results">
    <div class="section-label">Analysis Results</div>

    <!-- Meta bar -->
    <div class="meta-bar" id="meta-bar"></div>

    <!-- Country cards -->
    <div class="results-grid" id="results-grid"></div>
  </div>

  <!-- ── Footer ── -->
  <footer>
    <span class="footer-text">GeoIntel Decision Engine · Real-time public data</span>
    <div class="api-badges">
      <span class="api-badge">REST Countries</span>
      <span class="api-badge">World Bank</span>
      <span class="api-badge">OpenWeatherMap</span>
      <span class="api-badge">WAQI</span>
      <span class="api-badge">Travel Advisory</span>
    </div>
  </footer>
</div>

<script>
// ── Config ────────────────────────────────────────────────────────────────────
const API_URL = 'https://global-relocation-travel-decision.onrender.com/api/analyze';

// ── State ─────────────────────────────────────────────────────────────────────
let countries = [];
let isSubmitting = false;

// ── Live clock ────────────────────────────────────────────────────────────────
function updateClock() {
  const el = document.getElementById('live-time');
  if (el) el.textContent = new Date().toUTCString().replace(' GMT', ' UTC');
}
setInterval(updateClock, 1000);
updateClock();

// ── Country tag input ─────────────────────────────────────────────────────────
const tagInput   = document.getElementById('country-input');
const tagContainer = document.getElementById('tags-container');

function addCountry(name) {
  name = name.trim().replace(/,/g, '');
  if (!name) return;
  if (countries.map(c => c.toLowerCase()).includes(name.toLowerCase())) return;
  countries.push(name);
  renderTags();
  tagInput.value = '';
}

function removeCountry(name) {
  countries = countries.filter(c => c !== name);
  renderTags();
}

function renderTags() {
  // Remove all existing tags (not the input)
  Array.from(tagContainer.querySelectorAll('.country-tag')).forEach(el => el.remove());

  countries.forEach(name => {
    const tag = document.createElement('div');
    tag.className = 'country-tag';
    tag.innerHTML = `${name}<button class="tag-remove" onclick="removeCountry('${name}')" title="Remove">×</button>`;
    tagContainer.insertBefore(tag, tagInput);
  });
}

tagInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' || e.key === ',') {
    e.preventDefault();
    addCountry(tagInput.value);
  } else if (e.key === 'Backspace' && tagInput.value === '' && countries.length > 0) {
    countries.pop();
    renderTags();
  }
});

tagInput.addEventListener('blur', () => {
  if (tagInput.value.trim()) addCountry(tagInput.value);
});

// ── Toggle buttons ────────────────────────────────────────────────────────────
document.querySelectorAll('.toggle-group').forEach(group => {
  group.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
});

function getToggleVal(groupId) {
  return document.querySelector(`#${groupId} .toggle-btn.active`)?.dataset.val;
}

// ── Score helpers ─────────────────────────────────────────────────────────────
function scoreClass(v)    { return v >= 65 ? 'score-high' : v >= 40 ? 'score-mid' : 'score-low'; }
function fillClass(v)     { return v >= 65 ? 'fill-high'  : v >= 40 ? 'fill-mid'  : 'fill-low';  }
function scoreColor(v)    { return v >= 65 ? '#4caf7d' : v >= 40 ? '#c9a84c' : '#e05252'; }
function fmtScore(v)      { return v !== null && v !== undefined ? Math.round(v) : '—'; }
function fmtVal(v, unit)  { return (v !== null && v !== undefined) ? `${typeof v === 'number' ? v.toFixed(1) : v}${unit || ''}` : 'N/A'; }

// ── Main analysis ─────────────────────────────────────────────────────────────
async function runAnalysis() {
  if (isSubmitting) return;

  const errorEl   = document.getElementById('error-msg');
  errorEl.className = 'error-msg';

  // Collect any pending input
  if (tagInput.value.trim()) addCountry(tagInput.value);

  const riskTolerance = getToggleVal('risk-group');
  const duration      = getToggleVal('duration-group');

  if (countries.length < 3) {
    showError('Please add at least 3 countries to analyze.');
    return;
  }

  // Set loading state
  isSubmitting = true;
  document.getElementById('analyze-btn').disabled = true;
  document.getElementById('results').className = '';
  document.getElementById('loading-panel').className = 'loading-panel visible';

  try {
    const res = await fetch(API_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ countries, riskTolerance, duration }),
    });

    const data = await res.json();

    if (!res.ok || !data.success) {
      throw new Error(data.errors?.join(' ') || data.message || 'Analysis failed.');
    }

    renderResults(data);
  } catch (err) {
    document.getElementById('loading-panel').className = 'loading-panel';
    showError(err.message || 'Could not connect to the backend. Make sure the server is running on port 3001.');
  } finally {
    isSubmitting = false;
    document.getElementById('analyze-btn').disabled = false;
    document.getElementById('loading-panel').className = 'loading-panel';
  }
}

function showError(msg) {
  const el = document.getElementById('error-msg');
  el.textContent = '⚠ ' + msg;
  el.className = 'error-msg visible';
}

// ── Render results ────────────────────────────────────────────────────────────
function renderResults(data) {
  const { ranked_results, meta, weight_profile, failed_countries } = data;

  // Meta bar
  const cacheHits = meta.cache.hits.length;
  const cacheMisses = meta.cache.misses.length;
  document.getElementById('meta-bar').innerHTML = `
    <div class="meta-item">
      <span class="meta-key">RESPONSE TIME</span>
      <span class="meta-val ${meta.performance.response_time_ms < 2000 ? 'good' : 'warn'}">${meta.performance.response_time_ms}ms</span>
    </div>
    <div class="meta-item">
      <span class="meta-key">COUNTRIES ANALYZED</span>
      <span class="meta-val">${meta.performance.countries_analyzed}</span>
    </div>
    <div class="meta-item">
      <span class="meta-key">CACHE</span>
      <span class="meta-val"><span class="cache-dot hit"></span>${cacheHits} hit · <span class="cache-dot miss"></span>${cacheMisses} miss</span>
    </div>
    <div class="meta-item">
      <span class="meta-key">RISK PROFILE</span>
      <span class="meta-val">${meta.query.riskTolerance.toUpperCase()} / ${meta.query.duration.toUpperCase()}</span>
    </div>
    <div class="meta-item">
      <span class="meta-key">GENERATED AT</span>
      <span class="meta-val">${new Date(meta.generated_at).toUTCString().replace(' GMT', ' UTC')}</span>
    </div>
  `;

  // Cards
  const grid = document.getElementById('results-grid');
  grid.innerHTML = '';

  ranked_results.forEach(entry => {
    const { rank, rank_label, country, profile, raw_data, scores, cache_hit, data_availability } = entry;
    const s = scores;
    const tr = s.travel_risk_score;
    const hi = s.health_infrastructure_score;
    const es = s.environmental_stability_score;
    const comp = s.composite_score;

    const card = document.createElement('div');
    card.className = `country-card rank-${rank}`;

    const missingAPIs = Object.entries(data_availability || {}).filter(([, v]) => !v).map(([k]) => k);

    card.innerHTML = `
      <!-- Header -->
      <div class="card-header">
        <div class="rank-badge">${rank}</div>
        ${profile.flag_url ? `<img class="flag-img" src="${profile.flag_url}" alt="${country} flag" />` : ''}
        <div class="card-title-block">
          <div class="card-country-name">${country}</div>
          <div class="card-subtitle">
            ${profile.capital || 'N/A'} · ${profile.region || ''} · ${profile.currencies || 'N/A'}
            ${cache_hit ? ' · <span class="cache-dot hit" style="display:inline-block"></span>cached' : ''}
          </div>
        </div>
        <div class="composite-score">
          <div class="score-big ${scoreClass(comp)}">${fmtScore(comp)}</div>
          <div class="score-label">COMPOSITE SCORE</div>
          <span class="rank-label-tag">${rank_label}</span>
        </div>
      </div>

      <!-- Body: scores + profile -->
      <div class="card-body">
        <div class="score-section">
          <h4>Intelligence Scores</h4>
          <div class="score-bars">
            ${renderScoreBar('Travel Risk', tr?.score, weight_profile.travel_risk_score)}
            ${renderScoreBar('Health Infrastructure', hi?.score, weight_profile.health_infrastructure_score)}
            ${renderScoreBar('Environmental Stability', es?.score, weight_profile.environmental_stability_score)}
          </div>
        </div>
        <div class="profile-section">
          <h4>Country Profile</h4>
          <div class="profile-grid">
            <div class="profile-item">
              <span class="profile-key">Population</span>
              <span class="profile-val">${profile.population ? (profile.population / 1e6).toFixed(1) + 'M' : 'N/A'}</span>
            </div>
            <div class="profile-item">
              <span class="profile-key">Life Expectancy</span>
              <span class="profile-val">${fmtVal(raw_data.life_expectancy_years, ' yrs')}</span>
            </div>
            <div class="profile-item">
              <span class="profile-key">Health Expend.</span>
              <span class="profile-val">${fmtVal(raw_data.healthcare_expenditure_gdp_pct, '% GDP')}</span>
            </div>
            <div class="profile-item">
              <span class="profile-key">Advisory Score</span>
              <span class="profile-val">${raw_data.travel_advisory?.score?.toFixed(1) || 'N/A'}/5.0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Raw data chips -->
      <div class="card-data">
        <div class="data-chip">
          <div class="data-chip-key">Temperature</div>
          <div class="data-chip-val">${raw_data.weather ? raw_data.weather.temp_celsius?.toFixed(1) + '°C' : 'N/A'}</div>
        </div>
        <div class="data-chip">
          <div class="data-chip-key">Humidity</div>
          <div class="data-chip-val">${raw_data.weather ? raw_data.weather.humidity_pct + '%' : 'N/A'}</div>
        </div>
        <div class="data-chip">
          <div class="data-chip-key">Weather</div>
          <div class="data-chip-val">${raw_data.weather?.description || 'N/A'}</div>
        </div>
        <div class="data-chip">
          <div class="data-chip-key">AQI</div>
          <div class="data-chip-val ${raw_data.aqi ? scoreClass(100 - Math.min(raw_data.aqi.aqi, 100)) : ''}">${raw_data.aqi ? raw_data.aqi.aqi : 'N/A'}</div>
        </div>
        <div class="data-chip">
          <div class="data-chip-key">Pollutant</div>
          <div class="data-chip-val">${raw_data.aqi?.dominant_pollutant?.toUpperCase() || 'N/A'}</div>
        </div>
        <div class="data-chip">
          <div class="data-chip-key">Wind Speed</div>
          <div class="data-chip-val">${raw_data.weather ? raw_data.weather.wind_speed_ms + ' m/s' : 'N/A'}</div>
        </div>
      </div>

      ${missingAPIs.length > 0 ? `
      <div style="padding: 0 24px 12px; display:flex; gap:6px; flex-wrap:wrap;">
        <span class="missing-badge">partial data:</span>
        ${missingAPIs.map(k => `<span class="missing-badge">${k} unavailable</span>`).join('')}
      </div>` : ''}

      <!-- Reasoning -->
      <div class="card-reasoning">
        <div class="reasoning-title">Analysis Reasoning</div>
        <div class="reasoning-list">
          ${(s.reasoning || []).map(r => `<div class="reasoning-item">${r}</div>`).join('')}
        </div>
      </div>
    `;

    grid.appendChild(card);
  });

  // Animate score bars after render
  setTimeout(() => {
    document.querySelectorAll('.score-bar-fill').forEach(bar => {
      bar.style.width = bar.dataset.width + '%';
    });
  }, 50);

  // Show failed countries if any
  if (failed_countries?.length > 0) {
    const failedDiv = document.createElement('div');
    failedDiv.style.cssText = 'margin-top:16px; padding:16px; background:#e0525210; border:1px solid #e0525240; font-family:var(--mono); font-size:11px; color:#e05252;';
    failedDiv.innerHTML = '<strong>Could not analyze:</strong> ' + failed_countries.map(f => `${f.country} (${f.reason})`).join(' · ');
    grid.appendChild(failedDiv);
  }

  document.getElementById('results').className = 'visible';
  document.getElementById('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function renderScoreBar(label, value, weight) {
  const v = value ?? 50;
  const pct = Math.round(weight * 100);
  return `
    <div class="score-bar-row">
      <div class="score-bar-top">
        <span class="score-bar-name">${label} <span style="color:var(--text3);font-size:9px;">(${pct}%)</span></span>
        <span class="score-bar-val ${scoreClass(v)}">${fmtScore(v)}</span>
      </div>
      <div class="score-bar-track">
        <div class="score-bar-fill ${fillClass(v)}" data-width="${v}" style="width:0%"></div>
      </div>
    </div>
  `;
}
</script>
</body>
</html>
